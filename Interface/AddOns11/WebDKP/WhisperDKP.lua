function WebDKP_AddMessageEventFilters()ChatFrame_AddMessageEventFilter("CHAT_MSG_WHISPER",function(self,a,b,c,d,e,f,g,h,i,j,k,l,m,n)if WebDKP_IsWebDKPWhisper(c,b)then return true end end)ChatFrame_AddMessageEventFilter("CHAT_MSG_WHISPER_INFORM",function(self,a,b,c,d,e,f,g,h,i,j,k,l,m,n)if string.find(b,"^WebDKP: ")or string.find(b,"!Sending")or string.find(b,"!SendingAuto")then return true end end)end;function WebDKP_WhisperDKP_Event(b,c,o)local p=WebDKP_GetTableid()local q=c;local r=b;if WebDKP_IsWebDKPWhisper(q,r)then if string.find(string.lower(r),WebDKP.translations.triggerWhisperDKP)==1 then local s=WebDKP_GetMain(q,true)if WebDKP_DkpTable[s]==nil then WebDKP_SendWhisper(q,WebDKP.translations.WhisperDKP1)WebDKP_SendWhisper(q,WebDKP.translations.WhisperDKP2)else local t=WebDKP_GetDKP(s,p)local u=floor((t-1)/WebDKP_TierInterval)if t==0 then u=0 end;WebDKP_SendWhisper(q,WebDKP.translations.WhisperDKP3 ..t)WebDKP_SendWhisper(q,WebDKP.translations.WhisperDKP2)end elseif string.find(string.lower(r),WebDKP.translations.triggerWhisperDKP1)==1 then local v=WebDKP_GetWhisperFiltersFromMessage(r)WebDKP_WhisperSortedList(q,true,v)elseif r==WebDKP.translations.triggerWhisperDKP2 then WebDKP_Standby_GUIToggle("add",q,o)elseif r==WebDKP.translations.triggerWhisperDKP3 then WebDKP_Standby_GUIToggle("remove",q)elseif r==WebDKP.translations.triggerWhisperDKP4 then if WebDKP_CharRaidInfo[q]~=nil then local w=WebDKP_CharRaidInfo[q]["total_raids"]local x=WebDKP_CharRaidInfo[q]["raids_attended"]local y=WebDKP_CharRaidInfo[q]["percent"]WebDKP_SendWhisper(q,WebDKP.translations.WhisperDKP4 ..x..WebDKP.translations.WhisperDKP5 ..w..WebDKP.translations.WhisperDKP6 ..y.." %")else WebDKP_SendWhisper(q,WebDKP.translations.WhisperDKP7)end end end end;function WebDKP_IsWebDKPWhisper(q,r)if string.find(string.lower(r),"WebDKP:")then return false end;if string.find(string.lower(r),WebDKP.translations.triggerWhisperDKP)==1 or string.find(string.lower(r),WebDKP.translations.triggerWhisperDKP4)==1 or string.find(string.lower(r),WebDKP.translations.triggerWhisperDKP1)==1 or string.find(string.lower(r),WebDKP.translations.triggerWhisperDKP2)==1 or string.find(string.lower(r),WebDKP.translations.triggerWhisperDKP3)==1 or string.find(r,"!Sending")==1 or string.find(r,"!SendingAuto")==1 then return true end;return false end;function WebDKP_WhisperSortedList(z,A,B)local p=WebDKP_GetTableid()if B==nil then B={}end;local C={}for D,E in pairs(WebDKP_DkpTable)do if type(E)=="table"then local F=D;local G=E["class"]local H=WebDKP_GetDKP(F,p)if H~=nil then local I=floor((H-1)/WebDKP_TierInterval)if H==0 then I=0 end;if WebDKP_PassesWhisperFilter(F,G,H,I,A,B)then tinsert(C,{playerName=F,playerClass=G,playerDkp=H,playerTier=I})end end end end;table.sort(C,function(J,K)if J and K then if J.playerDkp==K.playerDkp then return J.playerName>=K.playerName else return J.playerDkp<=K.playerDkp end end end)for D,E in pairs(C)do if E.playerName~=nil and E.playerClass~=nil and E.playerDkp~=nil then WebDKP_SendWhisper(z,E.playerDkp.." : "..E.playerName.." ( "..E.playerClass.." ) ")end end end;function WebDKP_PassesWhisperFilter(q,L,t,u,A,v)L=WebDKP.translations.CLASS_LOCALIZED_TO_ENG_MAP[L]if A then if not WebDKP_PlayerInGroup(q)then return false end end;if v["showall"]then return true else if L==nil then return false end;return not(v[string.lower(L)]==nil)end end;function WebDKP_GetWhisperFiltersFromMessage(M)local v={}v["druid"]=string.find(string.lower(M),"druid")v["hunter"]=string.find(string.lower(M),"hunter")v["mage"]=string.find(string.lower(M),"mage")v["rogue"]=string.find(string.lower(M),"rogue")v["shaman"]=string.find(string.lower(M),"shaman")v["paladin"]=string.find(string.lower(M),"paladin")v["priest"]=string.find(string.lower(M),"priest")v["warrior"]=string.find(string.lower(M),"warrior")v["warlock"]=string.find(string.lower(M),"warlock")if WebDKP_GetTableSize(v)==0 then local N;for D,E in pairs(WebDKP.translations.CLASS_ALIAS_TO_ENG_MAP)do N=string.find(string.upper(M)," "..D)if N~=nil then v[E]=N end end end;if WebDKP_GetTableSize(v)==0 then local O;for D,E in pairs(WebDKP.translations.CLASS_LOCALIZED_TO_ENG_MAP)do O=string.find(string.upper(M)," "..D)if O~=nil then v[string.lower(E)]=O end end end;if v["druid"]==nil and v["hunter"]==nil and v["mage"]==nil and v["rogue"]==nil and v["shaman"]==nil and v["paladin"]==nil and v["priest"]==nil and v["warrior"]==nil and v["warlock"]==nil then v["showall"]=true else v["showall"]=false end;return v end
